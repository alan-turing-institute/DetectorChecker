title: "DetectorChecker Usage"
# author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# DetectorChecker

DetectorChecker package ...
```{r}
library(detectorchecker)
```

## Loading and visualising data

### To check available detectors:

```{r}
available_detectors
```

### To create detector object

```{r}
pilatus_detector <- create_detector("Pilatus")
```

### To visualise detector object

```{r}
plot_detector(pilatus_detector)
```

### Detector analysis

```{r}
#plot_pixel_ctr_eucl(pilatus_detector)
```

```{r}
#plot_pixel_ctr_linf(pilatus_detector)
```

```{r}
#plot_pixel_dist_corner(pilatus_detector)
```

```{r}
#plot_pixel_dist_edge_col(pilatus_detector)
```

```{r}
#plot_pixel_dist_edge_row(pilatus_detector)
```

```{r}
#plot_pixel_dist_edge(pilatus_detector)
```

### Importing user-defined detector
```{r}

file_path <- system.file("extdata", "user-defined", "simple", "user-defined.txt", package = "detectorchecker")

user_def_detector <- readin_detector(file_path)

plot_detector(user_def_detector)

```

### To upload pixel file

#### TIFF format

```{r}
pilatus_detector <- create_detector("Pilatus")

file_path <- system.file("extdata", "Pilatus", "badpixel_mask.tif", package = "detectorchecker")

pilatus_detector <- load_pix_matrix(detector = pilatus_detector, file_path = file_path)

plot_pixels(detector = pilatus_detector, caption = TRUE)

plot_pixels(detector = pilatus_detector, col = 4, row = 5, caption = TRUE)
```

#### XML format

```{r}
detector_perkin <- create_detector("PerkinElmerFull")

file_path <- system.file("extdata", "PerkinElmerFull", "BadPixelMap_t1.bpm.xml", package = "detectorchecker")

detector_perkin <- load_pix_matrix(detector = detector_perkin, file_path = file_path)

plot_pixels(detector = detector_perkin)
plot_pixels(detector = detector_perkin, col = 11, row = 2)
```

#### HDF

```{r}
detector_exc <- create_detector("Excalibur")

file_path <- c(
  system.file("extdata", "Excalibur", "pixelmask.fem1.hdf", package = "detectorchecker"),
  system.file("extdata", "Excalibur", "pixelmask.fem2.hdf", package = "detectorchecker"),
  system.file("extdata", "Excalibur", "pixelmask.fem3.hdf", package = "detectorchecker"),
  system.file("extdata", "Excalibur", "pixelmask.fem4.hdf", package = "detectorchecker"),
  system.file("extdata", "Excalibur", "pixelmask.fem5.hdf", package = "detectorchecker"),
  system.file("extdata", "Excalibur", "pixelmask.fem6.hdf", package = "detectorchecker"))

detector_exc <- load_pix_matrix(detector = detector_exc, file_path = file_path)

plot_pixels(detector = detector_exc)
plot_pixels(detector_exc, col = 1, row = 6)
```

### Damaged pixel density

```{r}
detector_perkin <- create_detector("PerkinElmerFull")

file_path <- system.file("extdata", "PerkinElmerFull", "BadPixelMap_t1.bpm.xml", package = "detectorchecker")

detector_perkin <- load_pix_matrix(detector = detector_perkin, file_path = file_path)

plot_pixels_density(detector = detector_perkin, adjust = 0.5)

plot_pixels_density(detector = detector_perkin, adjust = 0.5, row = 1, col = 2)

```

### Summaries

```{r}
detector_perkin <- create_detector("PerkinElmerFull")

file_path <- system.file("extdata", "PerkinElmerFull", "BadPixelMap_t1.bpm.xml", package = "detectorchecker")

detector_perkin <- load_pix_matrix(detector = detector_perkin, file_path = file_path)

cat(detector_summary(detector_perkin))
cat(dead_stats_summary(detector_perkin))
```

### Damaged pixel counts per module

```{r}
detector_perkin <- create_detector("PerkinElmerFull")

file_path <- system.file("extdata", "PerkinElmerFull", "BadPixelMap_t1.bpm.xml", package = "detectorchecker")

detector_perkin <- load_pix_matrix(detector = detector_perkin, file_path = file_path)

detector_perkin <- get_dead_stats(detector_perkin)

plot_pixels_count(detector = detector_perkin, caption = FALSE)

plot_pixels_count(detector = detector_perkin, row = 1, col = 5, caption = FALSE)
```

### Arrows

```{r}
detector_perkin <- create_detector("PerkinElmerFull")

file_path <- system.file("extdata", "PerkinElmerFull", "BadPixelMap_t1.bpm.xml", package = "detectorchecker")

detector_perkin <- load_pix_matrix(detector = detector_perkin, file_path = file_path)

plot_pixels_arrows(detector = detector_perkin)

plot_pixels_arrows(detector = detector_perkin, row = 1, col = 5)

```

# Angles

```{r}
detector_perkin <- create_detector("PerkinElmerFull")

file_path <- system.file("extdata", "PerkinElmerFull", "BadPixelMap_t1.bpm.xml", package = "detectorchecker")

detector_perkin <- load_pix_matrix(detector = detector_perkin, file_path = file_path)

plot_pixels_angles(detector = detector_perkin)

plot_pixels_angles(detector = detector_perkin, row = 1, col = 5)

```

## KFG Analysis

### K, F, G plots

```{r}
detector_perkin <- create_detector("PerkinElmerFull")

file_path <- system.file("extdata", "PerkinElmerFull", "BadPixelMap_t1.bpm.xml", package = "detectorchecker")

detector_perkin <- load_pix_matrix(detector = detector_perkin, file_path = file_path)

plot_pixels_kfg(detector = detector_perkin, func = "K", caption = FALSE)
plot_pixels_kfg(detector = detector_perkin, func = "F")
plot_pixels_kfg(detector = detector_perkin, func = "G")

plot_pixels_kfg(detector = detector_perkin, func = "K", row = 1, col = 5, caption = FALSE)
plot_pixels_kfg(detector = detector_perkin, func = "F", row = 1, col = 5, caption = FALSE)
plot_pixels_kfg(detector = detector_perkin, func = "G", row = 1, col = 5, caption = FALSE)
```

### Inhomogenious K, F, G plots

```{r}
detector_pilatus <- create_detector("Pilatus")

file_path <- system.file("extdata", "Pilatus", "badpixel_mask.tif", package = "detectorchecker")

detector_pilatus <- load_pix_matrix(detector = detector_pilatus, file_path = file_path)

plot_pixels_kfg(detector = detector_pilatus, func = "Kinhom")
plot_pixels_kfg(detector = detector_pilatus, func = "Finhom")
plot_pixels_kfg(detector = detector_pilatus, func = "Ginhom")

plot_pixels_kfg(detector = detector_pilatus, func = "Kinhom", row = 1, col = 5, caption = FALSE)
plot_pixels_kfg(detector = detector_pilatus, func = "Finhom", row = 1, col = 5, caption = FALSE)
plot_pixels_kfg(detector = detector_pilatus, func = "Ginhom", row = 1, col = 5, caption = FALSE)
```

### Events

```{r}
incl_event_list <- list(1,2,3,4,5,6,7,8)

detector_perkin <- create_detector("PerkinElmerFull")

file_path <- system.file("extdata", "PerkinElmerFull", "BadPixelMap_t1.bpm.xml", package = "detectorchecker")

detector_perkin <- load_pix_matrix(detector = detector_perkin, file_path = file_path)
plot_pixels(detector = detector_perkin)

detectorchecker::plot_events(detector_perkin, caption = FALSE, incl_event_list = incl_event_list)
```
```{r}
row_ = 2
col_ = 3
incl_event_list <- list(1,2,3,4,5,6,7,8)

detector_perkin <- create_detector("PerkinElmerFull")

file_path <- system.file("extdata", "PerkinElmerFull", "BadPixelMap_t1.bpm.xml", package = "detectorchecker")

detector_perkin <- load_pix_matrix(detector = detector_perkin, file_path = file_path)
plot_events(detector_perkin, row = row_, col = col_, incl_event_list = incl_event_list)
```
### Events 
```{r}

incl_event_list <- list(1,2,3,4,5,6,7,8)

detector_perkin <- create_detector("PerkinElmerFull")

file_path <- system.file("extdata", "PerkinElmerFull", "BadPixelMap_t1.bpm.xml", package = "detectorchecker")

detector_perkin <- load_pix_matrix(detector = detector_perkin, file_path = file_path)

# APPROACH 1
plot_events_count(detector_perkin, caption = FALSE, incl_event_list = incl_event_list)
plot_events_density(detector_perkin, caption = FALSE, incl_event_list = incl_event_list)
plot_events_arrows(detector_perkin, caption = FALSE, incl_event_list = incl_event_list)
plot_events_angles(detector_perkin, caption = FALSE, incl_event_list = incl_event_list)
plot_events_kfg(detector_perkin, func = "K", caption = FALSE, incl_event_list = incl_event_list)

# APPROACH 2 (faster than approach 1 if analysis is performed on the same clumps)
detector_events <- find_clumps(detector_perkin)
plot_events_count(detector_events, caption = FALSE, incl_event_list = incl_event_list)
plot_events_density(detector_events, caption = FALSE, incl_event_list = incl_event_list)
plot_events_arrows(detector_events, caption = FALSE, incl_event_list = incl_event_list)
plot_events_angles(detector_events, caption = FALSE, incl_event_list = incl_event_list)
plot_events_kfg(detector_events, func = "K", caption = FALSE, incl_event_list = incl_event_list)
```

### Events with selected rows and cols
```{r}

incl_event_list <- list(1,2,3,4,5,6,7,8)

detector_perkin <- create_detector("PerkinElmerFull")

file_path <- system.file("extdata", "PerkinElmerFull", "BadPixelMap_t1.bpm.xml", package = "detectorchecker")

detector_perkin <- load_pix_matrix(detector = detector_perkin, file_path = file_path)

# APPROACH 1
plot_events_count(detector_perkin, row = row_, col = col_, caption = FALSE, incl_event_list = incl_event_list)
plot_events_density(detector_perkin, row = row_, col = col_, caption = FALSE, incl_event_list = incl_event_list)
plot_events_arrows(detector_perkin, row = row_, col = col_, caption = FALSE, incl_event_list = incl_event_list)
plot_events_angles(detector_perkin, row = row_, col = col_, caption = FALSE, incl_event_list = incl_event_list)
plot_events_kfg(detector_perkin, func = "K", row = row_, col = col_, caption = FALSE, incl_event_list = incl_event_list)
plot_events_kfg(detector_perkin, func = "Kinhom", row = row_, col = col_, caption = FALSE, incl_event_list = incl_event_list)

# APPROACH 2 (faster than approach 1 if analysis is performed on the same clumps)
detector_events <- find_clumps(detector_perkin, row = row_, col = col_)

plot_events_count(detector_events, row = row_, col = col_, caption = FALSE, incl_event_list = incl_event_list)
plot_events_density(detector_events, row = row_, col = col_, caption = FALSE, incl_event_list = incl_event_list)
plot_events_arrows(detector_events, row = row_, col = col_, caption = FALSE, incl_event_list = incl_event_list)
plot_events_angles(detector_events, row = row_, col = col_, caption = FALSE, incl_event_list = incl_event_list)
plot_events_kfg(detector_events, func = "K", row = row_, col = col_, caption = FALSE, incl_event_list = incl_event_list)
plot_events_kfg(detector_events, func = "Kinhom", row = row_, col = col_, caption = FALSE, incl_event_list = incl_event_list)

```

### Removing areas of high density pixel damage from the analysis

```{r}
detector_perkin <- create_detector("PerkinElmerFull")

file_path <- system.file("extdata", "PerkinElmerFull", "BadPixelMap_t1.bpm.xml", package = "detectorchecker")

detector_perkin <- load_pix_matrix(detector = detector_perkin, file_path = file_path)
plot_pixels(detector = detector_perkin)

detector_perkin_modified <- remove_high_density_cluster(detector_perkin, min_pts = 30, eps_adjust = 0.05)
plot_pixels(detector = detector_perkin_modified)

```

### Pixels GLM fits

```{r}
detector_perkin <- create_detector("PerkinElmerFull")

file_path <- system.file("extdata", "PerkinElmerFull", "BadPixelMap_t1.bpm.xml", package = "detectorchecker")

detector_perkin <- load_pix_matrix(detector = detector_perkin, file_path = file_path)

glm_pixel_dist_edge_min(detector_perkin)

glm_pixel_dist_corner(detector_perkin)
```

### Events GLM fits

```{r}
detector_perkin <- create_detector("PerkinElmerFull")

file_path <- system.file("extdata", "PerkinElmerFull", "BadPixelMap_t1.bpm.xml", package = "detectorchecker")

detector_perkin <- load_pix_matrix(detector = detector_perkin, file_path = file_path)
detector_events <- find_clumps(detector_perkin)
```
# euclidean distance from centre
```{r}
incl_event_list <- list(1,2,3,4,5,6,7,8)
summary(glm_events_ctr_eucl(detector_events, incl_event_list=incl_event_list))
```

```{r}
incl_event_list <- list(1,2)
summary(glm_events_ctr_eucl(detector_events, incl_event_list=incl_event_list))
```

# L-infinity distance from centre
```{r}
incl_event_list <- list(1,2,3,4,5,6,7,8)
summary(glm_events_ctr_linf(detector_events, incl_event_list=incl_event_list))
```

# euclidean distance to nearest corner
```{r}
incl_event_list <- list(1,2,3,4,5,6,7,8)
summary(glm_events_dist_corner(detector_events, incl_event_list=incl_event_list))
```

# horizontal distance to nearest sub-panel edge
```{r}
incl_event_list <- list(1,2,3,4,5,6,7,8)
summary(glm_events_dist_edge_col(detector_events, incl_event_list=incl_event_list))
```

# vertical distance to nearest sub-panel edge
```{r}
incl_event_list <- list(1,2,3,4,5,6,7,8)
summary(glm_events_dist_edge_row(detector_events, incl_event_list=incl_event_list))
```

# L-infinity distance to nearest sub-panel edge
```{r}
incl_event_list <- list(1,2,3,4,5,6,7,8)
summary(glm_events_dist_edge_min(detector_events, incl_event_list=incl_event_list))
```


# Testing get_dead_stats error
```{r}
file_path <- system.file("extdata", "user-defined", "photographic", "layout_par_photographic.txt", package = "detectorchecker")

user_def_detector <- readin_detector(file_path)

plot_detector(user_def_detector)

file_path <- system.file("extdata", "user-defined", "photographic", "photographic.tif", package = "detectorchecker")

user_def_detector <- load_pix_matrix(detector = user_def_detector, file_path = file_path)

plot_pixels(detector = user_def_detector, caption = TRUE)

dead_stats_summary(user_def_detector)
```
