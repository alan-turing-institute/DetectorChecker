
title: "DetectorChecker Usage"
# author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# DetectorChecker

DetectorChecker package ...
```{r}
library(detectorchecker)
```

## Loading and visualising data

### To check available layouts:

```{r}
available_layouts
```

### To create layout object

```{r}
pilatus_layout <- create_module("Pilatus")
```

### To visualise layout object

```{r}
plot_layout(pilatus_layout)
```

### Layout analysis

```{r}
plot_pixel_ctr_eucl(pilatus_layout)
```

```{r}
plot_pixel_ctr_linf(pilatus_layout)
```

```{r}
plot_pixel_dist_corner(pilatus_layout)
```

```{r}
plot_pixel_dist_edge_col(pilatus_layout)
```

```{r}
plot_pixel_dist_edge_row(pilatus_layout)
```

```{r}
plot_pixel_dist_edge(pilatus_layout)
```

### Importing user-defined layout
```{r}
user_def_layout <- readin_layout("../tests/testthat/user-defined.dc")

plot_layout(user_def_layout)

```

### To upload pixel file

#### TIFF format

```{r}
pilatus_layout <- create_module("Pilatus")

file_path <- "../tests/testthat/dead_pix/Pilatus/badpixel_mask.tif"

pilatus_layout <- load_pix_matrix(layout = pilatus_layout, file_path = file_path)

plot_layout_damaged(layout = pilatus_layout, caption = FALSE)

plot_layout_module_damaged(layout = pilatus_layout, col = 4, row = 5, caption = FALSE)
```

#### XML format

```{r}
layout_perkin <- create_module("PerkinElmerFull")

file_path <- "../tests/testthat/dead_pix/PerkinElmer/BadPixelMap_0.bpm/BadPixelMap.bpm.xml"

layout_perkin <- load_pix_matrix(layout = layout_perkin, file_path = file_path)

plot_layout_damaged(layout = layout_perkin)
```

#### HDF

```{r}
layout_exc <- create_module("Excalibur")

file_path <- c("../tests/testthat/dead_pix/Excalibur/pixelmask.fem1.hdf", 
               "../tests/testthat/dead_pix/Excalibur/pixelmask.fem2.hdf",
               "../tests/testthat/dead_pix/Excalibur/pixelmask.fem3.hdf",
               "../tests/testthat/dead_pix/Excalibur/pixelmask.fem4.hdf",
               "../tests/testthat/dead_pix/Excalibur/pixelmask.fem5.hdf",
               "../tests/testthat/dead_pix/Excalibur/pixelmask.fem6.hdf")

layout_exc <- load_pix_matrix(layout = layout_exc, file_path = file_path)

plot_layout_damaged(layout = layout_exc)
```

### Damaged pixel density

```{r}
layout_perkin <- create_module("PerkinElmerFull")

file_path <- "../tests/testthat/dead_pix/PerkinElmer/BadPixelMap_0.bpm/BadPixelMap.bpm.xml"

layout_perkin <- load_pix_matrix(layout = layout_perkin, file_path = file_path)

plot_layout_density(layout = layout_perkin, adjust = 0.5)

plot_layout_density(layout = layout_perkin, adjust = 0.5, row = 1, col = 2)

```

### Summaries

```{r}
layout_perkin <- create_module("PerkinElmerFull")

file_path <- "../tests/testthat/dead_pix/PerkinElmer/BadPixelMap_0.bpm/BadPixelMap.bpm.xml"

layout_perkin <- load_pix_matrix(layout = layout_perkin, file_path = file_path)

cat(layout_summary(layout_perkin))
cat(dead_stats_summary(layout_perkin))
```

### Damaged pixel counts per module

```{r}
layout_perkin <- create_module("PerkinElmerFull")

file_path <- "../tests/testthat/dead_pix/PerkinElmer/BadPixelMap_0.bpm/BadPixelMap.bpm.xml"

layout_perkin <- load_pix_matrix(layout = layout_perkin, file_path = file_path)

layout_perkin <- get_dead_stats(layout_perkin)

plot_layout_cnt_mod(layout = layout_perkin, caption = FALSE)

plot_layout_cnt_mod(layout = layout_perkin, row = 1, col = 5, caption = FALSE)
```

### Arrows

```{r}
layout_perkin <- create_module("PerkinElmerFull")

file_path <- "../tests/testthat/dead_pix/PerkinElmer/BadPixelMap_0.bpm/BadPixelMap.bpm.xml"

layout_perkin <- load_pix_matrix(layout = layout_perkin, file_path = file_path)

plot_layout_arrows(layout = layout_perkin)

plot_layout_arrows(layout = layout_perkin, row = 1, col = 5)

```

# Angles

```{r}
layout_perkin <- create_module("PerkinElmerFull")

file_path <- "../tests/testthat/dead_pix/PerkinElmer/BadPixelMap_0.bpm/BadPixelMap.bpm.xml"

layout_perkin <- load_pix_matrix(layout = layout_perkin, file_path = file_path)

plot_layout_angles(layout = layout_perkin)

plot_layout_angles(layout = layout_perkin, row = 1, col = 5)

```

## Model fitting

```{r}
layout_pilatus <- create_module("Pilatus")

file_path <- "../tests/testthat/dead_pix/Pilatus/badpixel_mask.tif"

layout_pilatus <- load_pix_matrix(layout = layout_pilatus, file_path = file_path)

glm_fit <- glm_pixel_ctr_eucl(layout = layout_pilatus)

summary(glm_fit)
```

#### Similarly:
```{r}
layout_pilatus <- create_module("Pilatus")

file_path <- "../tests/testthat/dead_pix/Pilatus/badpixel_mask.tif"

layout_pilatus <- load_pix_matrix(layout = layout_pilatus, file_path = file_path)

dist_col <- dist_edge_col(layout_pilatus)
dist_row <- dist_edge_row(layout_pilatus)

glm_fit <- perform_glm(as.vector(layout_pilatus$pix_matrix) ~ as.vector(dist_col) + as.vector(dist_row))

summary(glm_fit)

```

## KFG Analysis

### K, F, G plots

```{r}
layout_perkin <- create_module("PerkinElmerFull")

file_path <- "../tests/testthat/dead_pix/PerkinElmer/BadPixelMap_0.bpm/BadPixelMap.bpm.xml"

layout_perkin <- load_pix_matrix(layout = layout_perkin, file_path = file_path)

plot_layout_kfg(layout = layout_perkin, func = "K")
plot_layout_kfg(layout = layout_perkin, func = "F")
plot_layout_kfg(layout = layout_perkin, func = "G")

plot_layout_kfg(layout = layout_perkin, func = "K", row = 1, col = 5, caption = FALSE)
plot_layout_kfg(layout = layout_perkin, func = "F", row = 1, col = 5, caption = FALSE)
plot_layout_kfg(layout = layout_perkin, func = "G", row = 1, col = 5, caption = FALSE)
```

### Inhomogenious K, F, G plots

```{r}
layout_pilatus <- create_module("Pilatus")

file_path <- "../tests/testthat/dead_pix/Pilatus/badpixel_mask.tif"

layout_pilatus <- load_pix_matrix(layout = layout_pilatus, file_path = file_path)

plot_layout_kfg(layout = layout_pilatus, func = "Kinhom")
plot_layout_kfg(layout = layout_pilatus, func = "Finhom")
plot_layout_kfg(layout = layout_pilatus, func = "Ginhom")

plot_layout_kfg(layout = layout_pilatus, func = "Kinhom", row = 1, col = 5, caption = FALSE)
plot_layout_kfg(layout = layout_pilatus, func = "Finhom", row = 1, col = 5, caption = FALSE)
plot_layout_kfg(layout = layout_pilatus, func = "Ginhom", row = 1, col = 5, caption = FALSE)
```

### Events

```{r}
layout_perkin <- create_module("PerkinElmerFull")

file_path <- "../tests/testthat/dead_pix/PerkinElmer/BadPixelMap_0.bpm/BadPixelMap.bpm.xml"

layout_perkin <- load_pix_matrix(layout = layout_perkin, file_path = file_path)

plot_layout_damaged(layout = layout_perkin)
```
```{r}

incl_event_list <- list(1,2,3,4,5,6,7,8)
      
layout_events <- detectorchecker::find_clumps(layout_perkin)
      
detectorchecker::plot_events(layout_events, caption = FALSE, incl_event_list = incl_event_list)
```
```{r}

row_ = 2
col_ = 3

layout_events <- detectorchecker::find_clumps(layout_perkin, row = row_, col = col_)

plot_module_events(layout_events, row = row_, col = col_, caption = FALSE, 
                   incl_event_list = incl_event_list)

```
### Events analysis
```{r}

layout_events <- detectorchecker::find_clumps(layout_perkin)
detectorchecker::plot_events_arrows(layout_events, caption = FALSE, incl_event_list = incl_event_list)

```

### Events with selected rows and cols
```{r}

detectorchecker::plot_events_density(layout_events, row = row_, col = col_, caption = FALSE, incl_event_list = incl_event_list)
detectorchecker::plot_events_arrows(layout_events, row = row_, col = col_, caption = FALSE, incl_event_list = incl_event_list)
detectorchecker::plot_events_angles(layout_events, row = row_, col = col_, caption = FALSE, incl_event_list = incl_event_list)
detectorchecker::plot_events_kfg(layout_events, func = "K", row = row_, col = col_, caption = FALSE, incl_event_list = incl_event_list)
detectorchecker::plot_events_kfg(layout_events, func = "Kinhom", row = row_, col = col_, caption = FALSE, incl_event_list = incl_event_list)

```
```{r}
detectorchecker::plot_events_count(layout_events, row = row_, col = col_, caption = FALSE, incl_event_list = incl_event_list)
```

### Model fitting

```{r}


layout_events <- detectorchecker::find_clumps(layout_perkin)

events_mask <- detectorchecker::get_events_mask(layout_events)


```
